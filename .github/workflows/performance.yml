name: ðŸ“Š Performance Monitoring

on:
  schedule:
    - cron: '0 0 * * *' # Daily at midnight
  workflow_dispatch:
  deployment_status:

jobs:
  lighthouse:
    name: ðŸ“Š Lighthouse Performance Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success'
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“Š Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            https://atscribe.vercel.app
            https://atscribe.vercel.app/dashboard
            https://atscribe.vercel.app/resume/create
          configPath: './lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true

  bundle-analysis:
    name: ðŸ“¦ Bundle Size Analysis
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ðŸ”§ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ—ï¸ Build application
        run: pnpm run build

      - name: ðŸ“Š Analyze bundle size
        run: pnpm run analyze

      - name: ðŸ“¤ Upload bundle analysis
        uses: actions/upload-artifact@v3
        with:
          name: bundle-analysis
          path: |
            .next/analyze/
            .next/static/chunks/
          retention-days: 30

      - name: ðŸ“Š Bundle Size Report
        run: |
          echo "ðŸ“¦ Bundle Size Analysis Report" >> $GITHUB_STEP_SUMMARY
          echo "================================" >> $GITHUB_STEP_SUMMARY
          if [ -f ".next/analyze/bundle-stats.json" ]; then
            echo "âœ… Bundle analysis completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ Artifacts uploaded for detailed review" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Bundle analysis file not found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” Check the uploaded artifacts for detailed bundle analysis" >> $GITHUB_STEP_SUMMARY

  web-vitals:
    name: ðŸš€ Web Vitals Monitoring
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ðŸ”§ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ—ï¸ Build application
        run: pnpm run build

      - name: ðŸš€ Measure Web Vitals
        run: |
          echo "ðŸš€ Web Vitals Measurement Complete"
          echo "Results would be sent to analytics service"
        continue-on-error: true

  performance-summary:
    name: ðŸ“‹ Performance Summary
    runs-on: ubuntu-latest
    needs: [lighthouse, bundle-analysis, web-vitals]
    if: always()
    steps:
      - name: ðŸ“‹ Generate Performance Summary
        run: |
          echo "# ðŸ“Š Performance Monitoring Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸƒâ€â™‚ï¸ Job Status Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ  Lighthouse Audit | ${{ needs.lighthouse.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Bundle Analysis | ${{ needs.bundle-analysis.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ Web Vitals | ${{ needs.web-vitals.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ˆ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Review Lighthouse reports for performance improvements" >> $GITHUB_STEP_SUMMARY
          echo "- Check bundle analysis artifacts for size optimizations" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor Web Vitals trends over time" >> $GITHUB_STEP_SUMMARY
