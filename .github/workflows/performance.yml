name: 📊 Performance Monitoring

on:
  schedule:
    - cron: '0 0 * * *' # Daily at midnight
  workflow_dispatch:
  deployment_status:

jobs:
  lighthouse:
    name: 📊 Lighthouse Performance Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success'
    steps:
      - name: 📦 Checkout code
        uses: actions/checkout@v4

      - name: 📊 Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            https://atscribe.vercel.app
            https://atscribe.vercel.app/dashboard
            https://atscribe.vercel.app/resume/create
          configPath: './lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true

  bundle-analysis:
    name: 📦 Bundle Size Analysis
    runs-on: ubuntu-latest
    steps:
      - name: 📦 Checkout code
        uses: actions/checkout@v4

      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: 🔧 Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: 📥 Install dependencies
        run: pnpm install --frozen-lockfile

      - name: 🏗️ Build application
        run: pnpm run build

      - name: 📊 Analyze bundle size
        run: pnpm run analyze

      - name: 📤 Upload bundle analysis
        uses: actions/upload-artifact@v3
        with:
          name: bundle-analysis
          path: |
            .next/analyze/
            .next/static/chunks/
          retention-days: 30

      - name: 📊 Bundle Size Report
        run: |
          echo "📦 Bundle Size Analysis Report" >> $GITHUB_STEP_SUMMARY
          echo "================================" >> $GITHUB_STEP_SUMMARY
          if [ -f ".next/analyze/bundle-stats.json" ]; then
            echo "✅ Bundle analysis completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "📁 Artifacts uploaded for detailed review" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Bundle analysis file not found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "🔍 Check the uploaded artifacts for detailed bundle analysis" >> $GITHUB_STEP_SUMMARY

  web-vitals:
    name: 🚀 Web Vitals Monitoring
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: 📦 Checkout code
        uses: actions/checkout@v4

      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: 🔧 Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: 📥 Install dependencies
        run: pnpm install --frozen-lockfile

      - name: 🏗️ Build application
        run: pnpm run build

      - name: 🚀 Measure Web Vitals
        run: |
          echo "🚀 Web Vitals Measurement Complete"
          echo "Results would be sent to analytics service"
        continue-on-error: true

  performance-summary:
    name: 📋 Performance Summary
    runs-on: ubuntu-latest
    needs: [lighthouse, bundle-analysis, web-vitals]
    if: always()
    steps:
      - name: 📋 Generate Performance Summary
        run: |
          echo "# 📊 Performance Monitoring Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 🏃‍♂️ Job Status Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 🏠 Lighthouse Audit | ${{ needs.lighthouse.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 📦 Bundle Analysis | ${{ needs.bundle-analysis.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 🚀 Web Vitals | ${{ needs.web-vitals.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 📈 Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Review Lighthouse reports for performance improvements" >> $GITHUB_STEP_SUMMARY
          echo "- Check bundle analysis artifacts for size optimizations" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor Web Vitals trends over time" >> $GITHUB_STEP_SUMMARY
